---
id: '12'
lezione: "20231107"
title: "Memory error exploits - Smashing the stack - Esercizi"
author: "Sam. K."
keywords: 
---

<style>
    strong{
        background-color:#faf43e;
        color: black;
        padding:0.1rem 0.2rem;
        border-radius:5px;
    }
</style>

# Memory Error - Countermeasures

developer
strcpy(), strncat ecc. safe dynamic link libs that checks the length of data before copying "dentro lo stack"?
non copia piu di quello che è stato dichiarato. funzioni sicure, 
os 
ASLR address space layout randomization

feature dell'os, che ad ogni esecuzione cambia l'indirizzo di dell'inizio stack
es. rende difficile il calcolo per trovare il Return Address

ˆˆˆc




ˆˆˆ
sudo sysctl -w kernel.randomize.va.space=1

compiler
stack-guard
protezione a livello compilazione

introduce un epilogo e prologo il copmilatore introducce una guardia
una guardia è unvalore che sta in una locazione di stack, che viene messo tra variabili e RA. se valore cambia vuol dire che qualcuno ha provato ad alterare lo stack

valore della guardia è un numero casuale che viene memorizzato in un registro dedicato della cpu. pero molto costosa.
quindi si usa un informazione pubblica
    
    # canary start
    mov1 %gs:20,%eax
    movl %eax,-12(%ebp)
    xorl %eax, %eax

    //do something

    # canary check 
    movl -12(%ebp), %ex
    xorl %gs:20,%eax
    je -L2
    call _stack_chk_fail

    _stack_chk_fail stampa stack smash detection

tutto quest viene fatto dal compilatore

chris eagle è inventore del canarino
canary terminator 0x00d0a000

posso bypassare canary test se metto il valore del canarino

ma questo non posso mettere dentro input con shellcode
perché 0x00 è un terminatore di stringa per gets() quindi non posso inserire tutto il codice di shellcode


hardware
non-executable stack

nx bit = No-eXecute feature in cpu separates

se cpu riceve un indirizzo dello stack per istruzione si blocca manda in seg fault, bit di protezione nelle pagine
può essere raggirato usando Return-to-libc attack

Data execution prevention non executable stack di microsft
una protezione di livello memoria presente dal win xp e win server 2003

# Malicious software - Malware
obbiettivo è quello di mandare in esecuzione un programma  da  un utente

NIST 800-83 definaes malware as : un prog che inserita in un os, normalmente furbamente, con intezione di compromettere la confidenzi, integrit o disponibilit dei dati, applicazioni di una vittima

tabella terminologia pag. 185

possono essere classificare in due  categorie
basati su come diffonde o propaga fino alla vittima

sulle azioni o payload che fa una volta raggiunto la vittima

classificati
 in base se ha bisogno di un agente su cui parassiti come virus

virus autonomi worms, trojans, and bot

malware che non si replica spam trojan

malware che si replica


metodi di propagazione
puo infettare il contenuto dal virus
sfruttament odi exploits che trova una vulnerabilità, shellcode diventa virale

il problema è convincere qualcuno a eseguire il programma

azioni del payload effetti del malware
puo compromettere il fuziona del sis oppur e il contenut odi un file
rubare servizi es. botnet
rubare infor
nascondersi in un sistema 

tool kits sono chiamati crimeware

es. Zeus
angler

chi li cea


advanced persistent threats apts
un attacco sponserizzato dai governi e
obiettivo è quello di rimanare (essere persistente) sulle macchine più a lungo possibile

alto livello Aurora, RSA, APT1 e Stuxnet

advance perchè è usa tecniche sofisticati
persistent 
threats

Viruses

azioni di un virus
può fare quello che può fare il programma compromesso

è composto da tre compo
meccanismo di infeione, come diffondone, infection vectore

trigger evento o condizione che determina quando il payload è attivato o ricevuto detto anche logic bomb

payload è quello che il virus dve fare


fase dormiente
triggergin fase
propagatio nfase
execution phase

prima cosa che fa è infettare

macro  e scripting virus 

sono virus che intaccano i documenti come pdf, word scritti in linguaggi piu avanzati come javascript or vbs

i virus tipicamnete si mettono nel boostsector (secondo programma) carica il kernel, vuoldire che il virus viene caricato prima
nei file, nei documenti come word, 

come fa un virus nascondersi, il codice del virus è crifrato. virus è diviso in due parti, una parte payload una parte che contiene routine che cifra e decifra.
antivirus si ocncentra su routing di deciframento perchè non è cifrata

viene individuato tramite il signature 

virus polimorfi è evouzione di virus cifrati che cambia signature ogni volta

quindi nn basta piu signatue per invididuare un virus.
uso un vm dove carico il virus e lo eseguo e controllo

contromisura dei virus
virus metamorfi
cambiano in generazione in generazione, ogni volta che viene infettato il vrus cambia

come si becca?
manda in esecuione il virus e si vede cosa fa, è necessaria una analisi dinamica

un virus ha bisogno di un corpo trasportatore

worm non ha bisogno di qualcuno che lo trasportasse

è una forma di malware che è in grado di gestirsi da solo 
come faccio eseguire un malware autonomamente
 
 lo faccio sfruttament oil codice gia in esecuzione

 servizio di rete è il programma che gestisce la porta

 il worm usa un bug di un servizio di rete

 worm replica

 target discovery

 errore di morris non controllva se la macchina ci fosse già la macchina, quindi le macchine crashavano per troppe worm

 virus ha bisogno del input di umano

 worm nn ha bisogno del intervento umano

 morris usava remote login per entrare
 ooppure usava bufferoverflow con comando finger

 primo ransomeware
 wannacry

 usa il bug ethernal blue, sono degli errori di del protocollo samba (windows) 


 mobile malware

 clickjacking


 social engineering
 convince un untente ad eseguire un codice maligno
 spam trojan horse mobile phone trojans 

 cosa un virus quando arriva in un sistema?
 in windows 95 e 98  tutti utenti erano amministratori del sistema
primo ranasomware nel 1989 il problam chiedere soldi , perché nn esisteva un metodo per prendere soldi essere beccato.

pegauss usava bug di adobe reader
installava una prima parte e poi scaricava il resto